# STP Solar - Solar System Builder & Admin Portal

A comprehensive solar system configuration and quote generation platform with integrated QuickBooks automation.

## üöÄ System Overview

This project consists of two main components:
1. **Main Website** (`index.html`) - Customer-facing solar system builder
2. **Admin Portal V2** (`admin-pricing-v2.html`) - Administrative interface for system configuration

## üìÅ Project Structure

```
stp-solar/
‚îú‚îÄ‚îÄ index.html                    # Main website with system builder
‚îú‚îÄ‚îÄ admin-pricing-v2.html         # Admin portal for configuration
‚îú‚îÄ‚îÄ solar-config-v2.js            # Data bridge between admin portal and website
‚îú‚îÄ‚îÄ solar-config-live.json        # Live configuration data (generated by admin portal)
‚îú‚îÄ‚îÄ styles.css                    # Main stylesheet with funky animations
‚îú‚îÄ‚îÄ script.js                     # Legacy script (for reference)
‚îú‚îÄ‚îÄ pricing-config.js             # Legacy pricing configuration
‚îî‚îÄ‚îÄ cache-buster.js               # Cache management utility
```

## üéØ Key Features

### Main Website (`index.html`)
- **Dynamic System Builder** with real-time pricing
- **Admin Portal Integration** - loads configurations dynamically
- **Funky Loading Animations** with cycling messages
- **Responsive Design** for all devices
- **QuickBooks Integration** via n8n webhook

### Admin Portal V2 (`admin-pricing-v2.html`)
- **System Definitions** - Create custom solar systems (e.g., Sunsynk, Deye)
- **Component Management** - Inverters, batteries, panels, roof types, accessories
- **Dynamic Configuration** - Set min/max quantities, default selections
- **Live Export** - Generate `solar-config-live.json` for website
- **Data Persistence** - Saves to localStorage with JSON backup

## üîß System Architecture

### Data Flow
```
Admin Portal V2 ‚Üí solar-config-live.json ‚Üí Main Website ‚Üí n8n Webhook ‚Üí QuickBooks
```

### Webhook Integration
The system integrates with n8n01.stpsolar.co.za for automated quote processing:

**Webhook Endpoint:** `https://n8n01.stpsolar.co.za/webhook/solar-quote`

**Payload Structure:**
```json
{
  "customer_name": "Customer Name",
  "customer_email": "customer@example.com",
  "customer_phone": "0123456789",
  "customer_location": "South Africa",
  "customer_message": "Optional message",
  "system_name": "Sunsynk 5kw System",
  "phase": "1760087693534",
  "line1_item_name": "Solar Product",
  "line1_description": "Sunsynk 5kw Inverter - 1x Inverter",
  "line1_amount": 16087,
  "line1_quantity": 1,
  "line2_item_name": "Solar Product",
  "line2_description": "Sunsynk 5kwh Battery - 2x Batterys",
  "line2_amount": 32174,
  "line2_quantity": 1,
  "line3_item_name": "Solar Product",
  "line3_description": "JA-Solar-565W - 7x Solar Panels",
  "line3_amount": 4066,
  "line3_quantity": 1,
  "line4_item_name": "Solar Product",
  "line4_description": "IBR Mounting Kit - 7x Panel Mounting Kit",
  "line4_amount": 7304,
  "line4_quantity": 1,
  "line5_item_name": "Solar Product",
  "line5_description": "Accessories - Installation Accessories & Hardware",
  "line5_amount": 10870,
  "line5_quantity": 1,
  "line6_item_name": "Solar Product",
  "line6_description": "Installation - Professional Installation & Commissioning",
  "line6_amount": 10870,
  "line6_quantity": 1,
  "total_price": 81371
}
```

### VAT Handling
- **Website Display:** Shows VAT-inclusive prices (R93,577)
- **Webhook Data:** Converts to VAT-exclusive amounts for QuickBooks
- **QuickBooks Processing:** Uses `TaxExcluded` mode, adds 15% VAT
- **Final Quote:** Matches website display (R93,577)

## üé® Funky Features

### Loading Animations
The quote request button features:
- **Cycling Messages** every 1.5 seconds with solar-themed text
- **Funky Pulse Animation** with color shifting
- **Glowing Effects** with pulsing shadows
- **Shimmer Effects** that sweep across the button
- **Rotating Spinner** with scaling effects

### Sample Loading Messages:
- ‚ö° Charging up the solar magic...
- üåû Calculating your energy savings...
- üîã Crunching numbers like a solar calculator...
- üí° Please wait while we work out magic...
- üåü Almost there, solar superstar!

## üîÑ Admin Portal Workflow

### 1. System Configuration
1. Open `admin-pricing-v2.html`
2. Configure components:
   - **Inverters** - Name and price
   - **Batteries** - Name and price
   - **Panels** - Name and price
   - **Roof Types** - Type and mounting kit price
   - **Accessories** - Installation hardware
   - **Installation** - Professional setup
3. Create **System Definitions** linking components
4. Set **Quantity Limits** (min/max batteries, panels)
5. Define **Default Selections** (roof type, etc.)

### 2. Export Configuration
1. Click **"Export for Live Server"**
2. Download `solar-config-live.json`
3. Upload to website root directory
4. Website automatically loads new configurations

### 3. Data Persistence
- **localStorage:** Primary storage for admin portal
- **JSON Backup:** `solar-config-live.json` for website fallback
- **Auto-migration:** Converts old data formats automatically

## üõ†Ô∏è Technical Implementation

### Data Bridge (`solar-config-v2.js`)
```javascript
// Key Functions:
- initializeDataBridge()     // Loads data from localStorage or JSON
- getSystemTypes()          // Returns available systems
- getSystemConfig(id)       // Gets specific system configuration
- calculateDynamicSystemPrice() // Calculates pricing with quantities
- getSystemDefaultRoofType() // Gets default roof type for system
```

### Pricing Calculation
```javascript
// Fixed Issues:
- Panel pricing: Only calculates selected panel (not all in system)
- Battery pricing: Only calculates selected battery (not all in system)
- VAT handling: Converts inclusive to exclusive for QuickBooks
- Quantity validation: Respects min/max limits from admin portal
```

### n8n Workflow Integration
- **Customer Management:** Auto-creates or finds existing customers
- **Line Item Processing:** Converts flat fields to QuickBooks Line array
- **Tax Calculation:** Handles VAT-inclusive to VAT-exclusive conversion
- **Email Integration:** Sends estimates directly to customer email

## üöÄ Deployment

### Live Server Setup
1. **Upload Files:**
   - `index.html` (main website)
   - `solar-config-v2.js` (data bridge)
   - `styles.css` (with animations)
   - `solar-config-live.json` (configuration)

2. **Admin Portal:**
   - Keep `admin-pricing-v2.html` for configuration
   - Export new configs when changes are made

3. **Webhook Integration:**
   - n8n workflow: "STP Solar ‚Ä¢ QuickBooks Estimate Creation"
   - Webhook URL: `https://n8n01.stpsolar.co.za/webhook/solar-quote`
   - QuickBooks API integration configured

## üîß Configuration Management

### Adding New Systems
1. **Admin Portal:**
   - Create new system definition
   - Link components (inverter, batteries, panels, etc.)
   - Set quantity limits and defaults
   - Export configuration

2. **Website:**
   - Automatically loads new systems
   - No code changes required
   - Dynamic dropdown population

### Modifying Pricing
1. **Update in Admin Portal**
2. **Export New Configuration**
3. **Upload to Website**
4. **Changes Apply Immediately**

## üìä Current Systems

### Sunsynk 5kw System
- **Inverter:** Sunsynk 5kw Inverter (R18,501)
- **Batteries:** Sunsynk 5kwh Battery (R18,500 each)
- **Panels:** JA-Solar-565W (R668 each) or Canadian-Solar-565W (R898 each)
- **Roof Types:** IBR/Tile (R1,200) or Concrete (R2,200)
- **Accessories:** R12,500
- **Installation:** R12,500

### Sunsynk 8kw System
- **Inverter:** Sunsynk 8kw Inverter (R29,850)
- **Same battery and panel options as 5kw system**
- **Higher capacity for larger installations**

## üéØ Key Improvements Made

### 1. Dynamic System Builder
- **Before:** Hardcoded systems and pricing
- **After:** Fully configurable via admin portal

### 2. Pricing Accuracy
- **Before:** Double-counting of components
- **After:** Accurate pricing for selected components only

### 3. VAT Consistency
- **Before:** Mismatched pricing between website and QuickBooks
- **After:** Consistent R93,577 display and quote generation

### 4. User Experience
- **Before:** Static "Sending..." message
- **After:** Funky animated loading with cycling messages

### 5. Admin Efficiency
- **Before:** Manual code changes for new systems
- **After:** Point-and-click system creation and export

## üîÆ Future Enhancements

- **Multi-language Support** for international markets
- **Advanced Reporting** in admin portal
- **Customer Portal** for quote tracking
- **Mobile App** integration
- **Advanced Analytics** and conversion tracking

## üìû Support

For technical support or feature requests, contact the development team.

---

**Version:** 2.0  
**Last Updated:** October 2025  
**Status:** Production Ready ‚úÖ
